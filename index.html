<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro Sinking Fund Cloud v1.0 - Official</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-blue: #003366; --danger-red: #dc3545; --success-green: #198754; --warning-gold: #ffc107; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        #adminDashboard, #memberDashboard, #topNav { display: none; }
        .navbar { background-color: var(--primary-blue); border-bottom: 3px solid var(--warning-gold); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .history-item { border-left: 5px solid var(--success-green); margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; }
        .history-item.unpaid { border-left-color: #dee2e6; color: #adb5bd; }
        .transparency-card { background: linear-gradient(135deg, #003366 0%, #00509d 100%); color: white; }
        .status-locked { opacity: 0.6; background-color: #fff5f5 !important; }
        .btn-google { background: white; color: #1f1f1f; border: 1px solid #747775; transition: background 0.2s; font-weight: 500; }
        .btn-google:hover { background: #f2f2f2; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loadingScreen" class="loading-overlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted">Authenticating with PH Server...</p>
    </div>
</div>

<div id="loginPage" class="container py-5 mt-5 text-center">
    <div class="card p-5 shadow-lg d-inline-block" style="max-width: 420px; width: 100%;">
        <h2 class="fw-bold text-primary mb-1">MSF Cloud</h2>
        <p class="text-muted mb-4 small">Official Sinking Fund Management System</p>
        
        <button class="btn btn-google w-100 py-2 d-flex align-items-center justify-content-center mb-3" onclick="signIn()">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48" class="me-3">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
            </svg>
            Sign in with Google
        </button>
        <div class="small text-muted mt-4">Authorized Member Only</div>
    </div>
</div>

<nav id="topNav" class="navbar navbar-dark mb-4 sticky-top">
    <div class="container d-flex justify-content-between">
        <span class="navbar-brand fw-bold">Micro Sinking Fund Cloud</span>
        <button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="signOut()">Logout</button>
    </div>
</nav>

<div id="adminDashboard" class="container">
    <div class="row mb-4 g-3 text-white text-center">
        <div class="col-md-4"><div class="card p-3 bg-primary"><h6>Total Fund</h6><h2 id="admTotalColl">₱0</h2></div></div>
        <div class="col-md-4"><div class="card p-3 bg-danger"><h6>Active Loans</h6><h2 id="admTotalLoans">₱0</h2></div></div>
        <div class="col-md-4"><div class="card p-3 bg-success"><h6>Total Profit</h6><h2 id="admProfit">₱0</h2></div></div>
    </div>

    <div class="card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-primary m-0">Master List</h5>
            <button class="btn btn-sm btn-success" onclick="suggestNextMonth()">+ Add Next Month</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center small">
                <thead id="tableHead" class="table-light"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card p-4 border-top border-primary border-5 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold text-primary">Member Control</h5>
                    <button class="btn btn-sm btn-primary" onclick="addMember()">+ Add</button>
                </div>
                <div id="memberControlList" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-4 border-top border-danger border-5 h-100">
                <h5 class="fw-bold text-danger">Loan Center</h5>
                <select id="loanTypeSelect" class="form-select mb-2" onchange="toggleLoanType()">
                    <option value="member">Member Loan</option>
                    <option value="non">Non-Member Loan</option>
                </select>
                <div id="memberLoanBox"><select id="loanMemberSelect" class="form-select mb-2"></select></div>
                <div id="nonMemberLoanBox" class="d-none">
                    <input type="text" id="nonMemberName" class="form-control mb-2" placeholder="Borrower Name">
                </div>
                <input type="number" id="loanAmtInput" class="form-control mb-3" placeholder="Amount (₱)">
                <button class="btn btn-danger w-100 fw-bold" onclick="releaseLoan()">RELEASE</button>
                <hr>
                <div id="loanLedgerList"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-4 border-top border-dark border-5 h-100">
                <h5 class="fw-bold">Site Settings</h5>
                <label class="small fw-bold">Contribution Amount (₱)</label>
                <input type="number" id="setConfigAmount" class="form-control mb-2">
                <label class="small fw-bold">Interest Rate (%)</label>
                <input type="number" id="setConfigInterest" class="form-control mb-3">
                <button class="btn btn-dark w-100 mb-3" onclick="updateSettings()">Save Settings</button>
                <hr>
                <h6 class="small fw-bold text-danger">Security Maintenance</h6>
                <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="resetMonthsToDefault()">Reset Months (Keep Members)</button>
                <button class="btn btn-danger btn-sm w-100" onclick="secureSystemWipe()">Full System Wipe (PIN Required)</button>
            </div>
        </div>
    </div>
</div>

<div id="memberDashboard" class="container">
    <div id="memberContent">
        <div class="row g-4 justify-content-center">
            <div class="col-lg-5">
                <div class="card p-4 transparency-card border-0 shadow mb-4 text-center">
                    <h2 id="mDashName" class="fw-bold mb-1"></h2>
                    <p id="mDashEmail" class="small opacity-75 mb-0"></p>
                    <hr class="bg-white">
                    <div class="row">
                        <div class="col-6"><small>Total Savings</small><h4 id="mDashContri" class="fw-bold">₱0</h4></div>
                        <div class="col-6"><small>My Interest</small><h4 id="mDashLoan" class="text-warning fw-bold">₱0</h4></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card p-4 h-100 shadow-sm"><h5>Payment History</h5><div id="paymentTimeline"></div></div>
            </div>
        </div>
    </div>
    <div id="lockedMessage" class="text-center py-5 d-none">
        <div class="card p-5"><h3>Access Restricted</h3><p>Your account is not registered or is currently locked.</p><button onclick="signOut()" class="btn btn-primary">Logout</button></div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyC5nSdDA5IrA0Gpt_nUcpT2NI0kdGGU3wI",
        authDomain: "sinking-fund-51fcd.firebaseapp.com",
        projectId: "sinking-fund-51fcd",
        storageBucket: "sinking-fund-51fcd.firebasestorage.app",
        messagingSenderId: "943953104162",
        appId: "1:943953104162:web:872f8dbc6f3fac7c63a97b"
    };

    const ADMIN_EMAIL = "ev.lorens.ebrado@gmail.com";
    const WIPE_PIN = "248617";
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const monthSequence = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let appData = { settings: { contri: 100, interest: 5 }, members: [], cycles: ["Jan"], loans: [], profit: 0 };

    // --- AUTH OBSERVER ---
    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection("system").doc("main").onSnapshot(doc => {
                if (doc.exists) appData = doc.data();
                else save();
                
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('topNav').style.display = 'block';
                document.getElementById('loginPage').style.display = 'none';

                if (user.email === ADMIN_EMAIL) {
                    showPage('adminDashboard');
                    renderAdmin();
                } else {
                    showPage('memberDashboard');
                    renderMember(user);
                }
            });
        } else {
            document.getElementById('loadingScreen').style.display = 'none';
            showPage('loginPage');
        }
    });

    // --- ADMIN RENDER ---
    function renderAdmin() {
        document.getElementById('setConfigAmount').value = appData.settings.contri;
        document.getElementById('setConfigInterest').value = appData.settings.interest;

        const head = document.getElementById('tableHead');
        let h1 = '<tr><th>Member</th>'; let h2 = '<tr><td></td>';
        appData.cycles.forEach(c => { h1 += `<th colspan="2" class="table-secondary">${c}</th>`; h2 += `<th class="small">15th</th><th class="small">30th</th>`; });
        head.innerHTML = h1 + '<th>Total</th></tr>' + h2 + '<td></td></tr>';

        const body = document.getElementById('tableBody'); body.innerHTML = '';
        let totalSavings = 0;
        appData.members.forEach((m, mIdx) => {
            let mSum = 0;
            let cells = `<td class="text-start"><b>${m.name}</b></td>`;
            m.payments.forEach((p, pIdx) => {
                if(p) mSum += appData.settings.contri;
                cells += `<td><input type="checkbox" class="form-check-input" ${p?'checked':''} onclick="togglePay(${mIdx},${pIdx})"></td>`;
            });
            totalSavings += mSum;
            body.innerHTML += `<tr class="${m.locked?'status-locked':''}">${cells}<td class="fw-bold text-success">₱${mSum.toLocaleString()}</td></tr>`;
        });

        const mCtrl = document.getElementById('memberControlList'); mCtrl.innerHTML = '';
        const lSel = document.getElementById('loanMemberSelect'); lSel.innerHTML = '<option value="">Select Borrower...</option>';
        appData.members.forEach((m, idx) => {
            lSel.innerHTML += `<option value="${m.name}">${m.name}</option>`;
            mCtrl.innerHTML += `<div class="list-group-item d-flex justify-content-between align-items-center small">
                <div><b>${m.name}</b><br><span class="text-muted small">${m.email}</span></div>
                <div class="btn-group"><button class="btn btn-sm btn-outline-warning" onclick="toggleLock(${idx})">${m.locked ? 'Unlock' : 'Lock'}</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteMember(${idx})">×</button></div></div>`;
        });

        const loanList = document.getElementById('loanLedgerList'); loanList.innerHTML = '';
        let loanVal = 0;
        appData.loans.forEach((l, idx) => {
            loanVal += l.principal;
            loanList.innerHTML += `<div class="p-2 border-bottom d-flex justify-content-between align-items-center mb-2 bg-light rounded small">
                <span>${l.borrower} (₱${l.principal})</span><button class="btn btn-sm btn-success py-0" onclick="collectLoan(${idx})">Collect</button></div>`;
        });

        document.getElementById('admTotalColl').innerText = `₱${(totalSavings + (appData.profit || 0)).toLocaleString()}`;
        document.getElementById('admTotalLoans').innerText = `₱${loanVal.toLocaleString()}`;
        document.getElementById('admProfit').innerText = `₱${(appData.profit || 0).toLocaleString()}`;
    }

    // --- SECURE WIPE ---
    function secureSystemWipe() {
        const pin = prompt("CRITICAL: Enter Wipe PIN (248617) to erase ALL data:");
        if (pin === WIPE_PIN) {
            if (confirm("FINAL WARNING: This zeroes everything (Profit, Loans, Members). Continue?")) {
                appData = { settings: { contri: 100, interest: 5 }, members: [], cycles: ["Jan"], loans: [], profit: 0 };
                save();
                location.reload();
            }
        } else if (pin !== null) alert("Incorrect PIN.");
    }

    // --- MEMBER LOGIC ---
    function renderMember(user) {
        const member = appData.members.find(m => m.email.toLowerCase() === user.email.toLowerCase());
        if(!member || member.locked) {
            document.getElementById('memberContent').classList.add('d-none');
            document.getElementById('lockedMessage').classList.remove('d-none');
            return;
        }
        document.getElementById('mDashName').innerText = member.name;
        document.getElementById('mDashEmail').innerText = member.email;
        let saved = 0; const timeline = document.getElementById('paymentTimeline'); timeline.innerHTML = '';
        member.payments.forEach((p, idx) => {
            const cy = appData.cycles[Math.floor(idx/2)];
            const cut = idx % 2 === 0 ? "15th" : "30th";
            if(p) saved += appData.settings.contri;
            timeline.innerHTML += `<div class="history-item ${p?'':'unpaid'} d-flex justify-content-between"><span>${cy} ${cut} Contribution</span><b>${p ? '₱'+appData.settings.contri : 'UNPAID'}</b></div>`;
        });
        document.getElementById('mDashContri').innerText = `₱${saved.toLocaleString()}`;
    }

    // --- CORE TOOLS ---
    function toggleLock(idx) { appData.members[idx].locked = !appData.members[idx].locked; save(); }
    function deleteMember(idx) { if(confirm("Delete member?")) { appData.members.splice(idx, 1); save(); } }
    function togglePay(mIdx, pIdx) { appData.members[mIdx].payments[pIdx] = !appData.members[mIdx].payments[pIdx]; save(); }
    function addMember() { const n = prompt("Name:"); const e = prompt("Email:"); if(n && e) { appData.members.push({ name: n, email: e.trim().toLowerCase(), locked: false, payments: new Array(appData.cycles.length*2).fill(false) }); save(); } }
    function releaseLoan() { const type = document.getElementById('loanTypeSelect').value; const amt = parseFloat(document.getElementById('loanAmtInput').value); let name = type === 'member' ? document.getElementById('loanMemberSelect').value : document.getElementById('nonMemberName').value; if(amt && name) { appData.loans.push({ borrower: name, principal: amt }); save(); document.getElementById('loanAmtInput').value = ''; } }
    function collectLoan(idx) { appData.profit = (appData.profit || 0) + (appData.loans[idx].principal * (appData.settings.interest/100)); appData.loans.splice(idx, 1); save(); }
    function suggestNextMonth() { const lastMonth = appData.cycles[appData.cycles.length - 1]; const nextMonth = monthSequence[(monthSequence.indexOf(lastMonth) + 1) % 12]; const val = prompt("Add Month:", nextMonth); if(val) { appData.cycles.push(val); appData.members.forEach(m => m.payments.push(false, false)); save(); } }
    function updateSettings() { appData.settings.contri = parseFloat(document.getElementById('setConfigAmount').value); appData.settings.interest = parseFloat(document.getElementById('setConfigInterest').value); save(); alert("Updated!"); }
    function resetMonthsToDefault() { if(confirm("Reset all cycles?")) { appData.cycles = ["Jan"]; appData.members.forEach(m => m.payments = [false, false]); save(); } }
    function toggleLoanType() { document.getElementById('memberLoanBox').classList.toggle('d-none', document.getElementById('loanTypeSelect').value !== 'member'); document.getElementById('nonMemberLoanBox').classList.toggle('d-none', document.getElementById('loanTypeSelect').value !== 'non'); }
    function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function signOut() { auth.signOut().then(() => location.reload()); }
    function showPage(id) { ['loginPage', 'adminDashboard', 'memberDashboard'].forEach(p => document.getElementById(p).style.display = (p === id) ? 'block' : 'none'); }
    function save() { db.collection("system").doc("main").set(appData); }
</script>
</body>
</html>
