<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PH SF Cloud v10.22 - Final Stable</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-blue: #003366; --danger-red: #dc3545; --success-green: #198754; --warning-gold: #ffc107; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 0; }
        #adminDashboard, #memberDashboard, #topNav { display: none; }
        
        /* LOGIN UI */
        #loginPage { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #f4f7f6; }
        .login-card { background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center; }
        .btn-google { background: white; color: #1f1f1f; border: 1px solid #dadce0; font-weight: 500; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 10px; margin-top: 20px; }

        /* SCALABLE UI COMPONENTS */
        .navbar { background-color: var(--primary-blue); border-bottom: 3px solid var(--warning-gold); }
        .ledger-wrapper { max-height: 500px; overflow: auto; border: 1px solid #dee2e6; border-radius: 10px; background: white; }
        .table-ledger thead { position: sticky; top: 0; z-index: 10; background: #f8f9fa; }
        .table-ledger th:first-child, .table-ledger td:first-child { position: sticky; left: 0; z-index: 11; background: #fff; border-right: 2px solid #dee2e6; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.06); }
        .history-item { border-left: 5px solid var(--success-green); margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; }
        .history-item.unpaid { border-left-color: #dee2e6; color: #adb5bd; }
        .transparency-card { background: linear-gradient(135deg, #003366 0%, #00509d 100%); color: white; }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="login-card">
        <h2 class="fw-bold text-primary mb-1">SF Cloud</h2>
        <p class="text-muted mb-4 small">Secure Management System v10.22</p>
        <button class="btn btn-google" onclick="signIn()">
            <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.63-.06-1.25-.16-1.84H9v3.49h4.84c-.21 1.12-.84 2.07-1.79 2.71v2.25h2.91c1.7-1.56 2.68-3.86 2.68-6.61z" fill="#4285F4"/><path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.91-2.25c-.81.54-1.85.86-3.05.86-2.34 0-4.33-1.58-5.04-3.71H.95v2.33C2.43 15.89 5.5 18 9 18z" fill="#34A853"/><path d="M3.96 10.71c-.18-.54-.28-1.12-.28-1.71s.1-1.17.28-1.71V4.96H.95C.35 6.17 0 7.55 0 9s.35 2.83.95 4.04l3.01-2.33z" fill="#FBBC05"/><path d="M9 3.58c1.32 0 2.5.45 3.44 1.35l2.58-2.58C13.47.89 11.43 0 9 0 5.5 0 2.43 2.11.95 5.12l3.01 2.33c.71-2.13 2.7-3.71 5.04-3.71z" fill="#EA4335"/></svg>
            Sign in with Google
        </button>
    </div>
</div>

<nav id="topNav" class="navbar navbar-dark mb-4 sticky-top">
    <div class="container d-flex justify-content-between">
        <span class="navbar-brand fw-bold">ðŸ‡µðŸ‡­ SF PRO v10.22</span>
        <button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="signOut()">Logout</button>
    </div>
</nav>

<div id="adminDashboard" class="container-fluid px-4">
    <div class="row mb-4 g-3 text-white text-center">
        <div class="col-md-4"><div class="card p-3 bg-primary"><h6>Total Capital pool</h6><h2 id="admTotalColl">â‚±0.00</h2></div></div>
        <div class="col-md-4"><div class="card p-3 bg-danger"><h6>Active Loan Principal</h6><h2 id="admTotalLoans">â‚±0.00</h2></div></div>
        <div class="col-md-4"><div class="card p-3 bg-success"><h6>Total Interest Profit</h6><h2 id="admProfit">â‚±0.00</h2></div></div>
    </div>

    <div class="card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-primary m-0">Master Ledger (Scalable)</h5>
            <button class="btn btn-sm btn-success" onclick="suggestNextMonth()">+ Add Next Month</button>
        </div>
        <div class="ledger-wrapper">
            <table class="table table-bordered table-ledger align-middle text-center small mb-0">
                <thead id="tableHead" class="table-light"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card p-4 border-top border-primary border-5 h-100">
                <h5 class="fw-bold text-primary">Members (<span id="countMembers">0</span>)</h5>
                <button class="btn btn-sm btn-outline-primary mb-3 w-100" onclick="addMember()">+ Register New Member</button>
                <div id="memberControlList" class="list-group list-group-flush overflow-auto" style="max-height: 350px;"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4 border-top border-danger border-5 h-100">
                <h5 class="fw-bold text-danger">Loan Center</h5>
                <select id="loanTypeSelect" class="form-select mb-2" onchange="toggleLoanType()"><option value="member">Member Loan</option><option value="non">Non-Member Loan</option></select>
                <div id="memberLoanBox"><select id="loanMemberSelect" class="form-select mb-2"></select></div>
                <div id="nonMemberLoanBox" class="d-none"><input type="text" id="nonMemberName" class="form-control mb-2" placeholder="Borrower Name"></div>
                <input type="number" id="loanAmtInput" class="form-control mb-3" placeholder="Principal Amount (â‚±)">
                <button class="btn btn-danger w-100 fw-bold" onclick="releaseLoan()">RELEASE FUNDS</button>
                <hr><div id="loanLedgerList" class="overflow-auto" style="max-height: 200px;"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4 border-top border-dark border-5 h-100">
                <h5 class="fw-bold">Cloud Settings</h5>
                <label class="small fw-bold">Cutoff Contribution (â‚±)</label><input type="number" id="setConfigAmount" class="form-control mb-2">
                <label class="small fw-bold">Interest Rate (%)</label><input type="number" id="setConfigInterest" class="form-control mb-3">
                <button class="btn btn-dark w-100 mb-3" onclick="updateSettings()">Save & Sync Cloud</button>
                <hr>
                <button class="btn btn-danger btn-sm w-100" onclick="secureSystemWipe()">Full System Wipe</button>
            </div>
        </div>
    </div>
</div>

<div id="memberDashboard" class="container">
    <div class="row g-3 mb-4 text-center">
        <div class="col-6 col-md-3"><div class="card p-2 shadow-sm"><small class="text-muted">Total Pool</small><h6 id="mTotalPool" class="mb-0 fw-bold">â‚±0.00</h6></div></div>
        <div class="col-6 col-md-3"><div class="card p-2 shadow-sm"><small class="text-muted">Active Loans</small><h6 id="mTotalLoans" class="mb-0 fw-bold">â‚±0.00</h6></div></div>
        <div class="col-6 col-md-3"><div class="card p-2 shadow-sm"><small class="text-muted">Total Interest</small><h6 id="mTotalInterest" class="mb-0 fw-bold text-success">â‚±0.00</h6></div></div>
        <div class="col-6 col-md-3"><div class="card p-2 shadow-sm"><small class="text-muted">Rate</small><h6 id="mTotalRate" class="mb-0 fw-bold text-primary">0%</h6></div></div>
    </div>
    <div id="memberContent" class="row g-4">
        <div class="col-lg-5">
            <div class="card p-4 transparency-card border-0 mb-4 shadow text-center">
                <h2 id="mDashName" class="fw-bold mb-1"></h2>
                <p id="mDashEmail" class="small opacity-75 mb-0"></p>
                <hr class="bg-white">
                <div class="row">
                    <div class="col-6 border-end"><small class="text-uppercase" style="font-size:0.7rem">My Total Savings</small><h3 id="mDashContri" class="fw-bold mb-0">â‚±0.00</h3></div>
                    <div class="col-6"><small class="text-uppercase" style="font-size:0.7rem">My Active Loan</small><h3 id="mDashLoan" class="text-warning fw-bold mb-0">â‚±0.00</h3><small id="mDashLoanDetail" class="opacity-75" style="font-size:0.65rem"></small></div>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card p-4 shadow-sm h-100">
                <h5 class="fw-bold border-bottom pb-2">Verified Payment Ledger</h5>
                <div id="paymentTimeline" class="overflow-auto" style="max-height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC5nSdDA5IrA0Gpt_nUcpT2NI0kdGGU3wI",
        authDomain: "sinking-fund-51fcd.firebaseapp.com",
        projectId: "sinking-fund-51fcd",
        storageBucket: "sinking-fund-51fcd.firebasestorage.app",
        messagingSenderId: "943953104162",
        appId: "1:943953104162:web:872f8dbc6f3fac7c63a97b"
    };

    const ADMIN_EMAIL = "ev.lorens.ebrado@gmail.com";
    const OB_WIPE = "MjQ4NjE3";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const monthSequence = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let appData = { settings: { contri: 100, interest: 5 }, members: [], cycles: ["Jan"], loans: [], profit: 0 };

    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection("system").doc("main").onSnapshot(doc => {
                if (doc.exists) appData = doc.data();
                else save();
                
                document.getElementById('topNav').style.display = 'block';
                document.getElementById('loginPage').style.display = 'none';

                if (user.email === ADMIN_EMAIL) { showPage('adminDashboard'); renderAdmin(); } 
                else { showPage('memberDashboard'); renderMember(user); }
            });
        } else {
            showPage('loginPage');
            document.getElementById('topNav').style.display = 'none';
        }
    });

    function renderAdmin() {
        document.getElementById('setConfigAmount').value = appData.settings.contri;
        document.getElementById('setConfigInterest').value = appData.settings.interest;
        document.getElementById('countMembers').innerText = appData.members.length;

        const head = document.getElementById('tableHead');
        let h1 = '<tr><th>Member Name</th>'; let h2 = '<tr><td></td>';
        appData.cycles.forEach(c => { 
            h1 += `<th colspan="2" class="bg-primary text-white">${c}</th>`; 
            h2 += `<th class="small">15th</th><th class="small">30th</th>`; 
        });
        head.innerHTML = h1 + '<th class="bg-dark text-white">Total</th></tr>' + h2 + '<td></td></tr>';

        const body = document.getElementById('tableBody'); body.innerHTML = '';
        let totalSavings = 0;
        appData.members.forEach((m, mIdx) => {
            let mSum = 0;
            let cells = `<td class="text-start fw-bold">${m.name}</td>`;
            m.payments.forEach((p, pIdx) => {
                if(p) mSum += Number(appData.settings.contri);
                cells += `<td><input type="checkbox" class="form-check-input" ${p?'checked':''} onclick="togglePay(${mIdx},${pIdx})"></td>`;
            });
            totalSavings += mSum;
            body.innerHTML += `<tr>${cells}<td class="fw-bold text-success">â‚±${mSum.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
        });

        const mCtrl = document.getElementById('memberControlList'); mCtrl.innerHTML = '';
        const lSel = document.getElementById('loanMemberSelect'); lSel.innerHTML = '<option value="">Select Borrower...</option>';
        appData.members.forEach((m, idx) => {
            lSel.innerHTML += `<option value="${m.name}">${m.name}</option>`;
            mCtrl.innerHTML += `<div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <div><div class="fw-bold">${m.name}</div><div class="text-muted" style="font-size:0.7rem">${m.email}</div></div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteMember(${idx})">Ã—</button></div>`;
        });

        let loanVal = 0;
        const loanList = document.getElementById('loanLedgerList'); loanList.innerHTML = '';
        appData.loans.forEach((l, idx) => {
            loanVal += Number(l.principal);
            loanList.innerHTML += `<div class="p-2 border-bottom d-flex justify-content-between align-items-center mb-1 bg-light rounded small">
                <span><b>${l.borrower}</b> (â‚±${Number(l.principal).toFixed(2)})</span><button class="btn btn-sm btn-success py-0" onclick="collectLoan(${idx})">Collect</button></div>`;
        });

        document.getElementById('admTotalColl').innerText = `â‚±${(totalSavings + Number(appData.profit)).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('admTotalLoans').innerText = `â‚±${loanVal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('admProfit').innerText = `â‚±${Number(appData.profit).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function renderMember(user) {
        const member = appData.members.find(m => m.email.toLowerCase() === user.email.toLowerCase());
        if(!member) return;

        let totalPoolSavings = 0;
        appData.members.forEach(m => m.payments.forEach(p => { if(p) totalPoolSavings += Number(appData.settings.contri); }));
        document.getElementById('mTotalPool').innerText = `â‚±${(totalPoolSavings + Number(appData.profit)).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('mTotalInterest').innerText = `â‚±${Number(appData.profit).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('mTotalRate').innerText = `${appData.settings.interest}%`;
        
        let loanVal = 0;
        appData.loans.forEach(l => loanVal += Number(l.principal));
        document.getElementById('mTotalLoans').innerText = `â‚±${loanVal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;

        document.getElementById('mDashName').innerText = member.name;
        document.getElementById('mDashEmail').innerText = member.email;
        let mySaved = 0; const timeline = document.getElementById('paymentTimeline'); timeline.innerHTML = '';
        member.payments.forEach((p, idx) => {
            const cy = appData.cycles[Math.floor(idx/2)];
            const cut = idx % 2 === 0 ? "15th" : "30th";
            if(p) mySaved += Number(appData.settings.contri);
            timeline.innerHTML += `<div class="history-item ${p?'':'unpaid'} d-flex justify-content-between align-items-center">
                <div><b>${cy} ${cut} Cutoff</b><br><small>${p?'Verified Payment':'Waiting for Admin Check'}</small></div>
                <div class="fw-bold">${p ? 'â‚±'+Number(appData.settings.contri).toFixed(2) : 'PENDING'}</div></div>`;
        });
        document.getElementById('mDashContri').innerText = `â‚±${mySaved.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        
        const myLoan = appData.loans.find(l => l.borrower === member.name);
        if(myLoan) {
            const int = Number(myLoan.principal) * (Number(appData.settings.interest)/100);
            document.getElementById('mDashLoan').innerText = `â‚±${(Number(myLoan.principal) + int).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('mDashLoanDetail').innerText = `P:${Number(myLoan.principal).toFixed(2)} + I:${int.toFixed(2)}`;
        } else {
            document.getElementById('mDashLoan').innerText = "â‚±0.00";
            document.getElementById('mDashLoanDetail').innerText = "";
        }
    }

    function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function signOut() { auth.signOut().then(() => location.reload()); }
    function showPage(id) { 
        ['loginPage', 'adminDashboard', 'memberDashboard'].forEach(p => {
            const el = document.getElementById(p);
            el.style.display = (p === id) ? (p === 'loginPage' ? 'flex' : 'block') : 'none';
        }); 
    }
    function save() { db.collection("system").doc("main").set(appData); }
    function togglePay(mIdx, pIdx) { appData.members[mIdx].payments[pIdx] = !appData.members[mIdx].payments[pIdx]; save(); }
    function deleteMember(idx) { if(confirm("Delete member?")) { appData.members.splice(idx, 1); save(); } }
    function toggleLoanType() {
        const type = document.getElementById('loanTypeSelect').value;
        document.getElementById('memberLoanBox').classList.toggle('d-none', type !== 'member');
        document.getElementById('nonMemberLoanBox').classList.toggle('d-none', type !== 'non');
    }
    function updateSettings() {
        appData.settings.contri = Number(document.getElementById('setConfigAmount').value);
        appData.settings.interest = Number(document.getElementById('setConfigInterest').value);
        save(); alert("Cloud Updated.");
    }
    function suggestNextMonth() {
        const last = appData.cycles[appData.cycles.length - 1];
        const next = monthSequence[(monthSequence.indexOf(last) + 1) % 12];
        const val = prompt("Add Cycle:", next);
        if(val) {
            appData.cycles.push(val);
            appData.members.forEach(m => {
                // Bug fix: Ensure array grows correctly relative to cycle count
                while(m.payments.length < appData.cycles.length * 2) m.payments.push(false);
            });
            save();
        }
    }
    function releaseLoan() {
        const type = document.getElementById('loanTypeSelect').value;
        const amt = Number(document.getElementById('loanAmtInput').value);
        let name = type === 'member' ? document.getElementById('loanMemberSelect').value : document.getElementById('nonMemberName').value;
        if(amt && name) { appData.loans.push({ borrower: name, principal: amt }); save(); document.getElementById('loanAmtInput').value = ''; }
    }
    function collectLoan(idx) {
        const interestEarned = Number(appData.loans[idx].principal) * (Number(appData.settings.interest)/100);
        appData.profit = Number(appData.profit) + interestEarned;
        appData.loans.splice(idx, 1);
        save();
    }
    function addMember() {
        const n = prompt("Member Name:");
        const e = prompt("Member Google Email:");
        if(n && e) {
            appData.members.push({ name: n, email: e.trim().toLowerCase(), payments: new Array(appData.cycles.length*2).fill(false) });
            save();
        }
    }
    function secureSystemWipe() {
        if(btoa(prompt("Enter PIN:")) === OB_WIPE) {
            if(confirm("WIPE EVERYTHING?")) {
                appData = { settings: { contri: 100, interest: 5 }, members: [], cycles: ["Jan"], loans: [], profit: 0 };
                save(); location.reload();
            }
        }
    }
</script>
</body>
</html>
