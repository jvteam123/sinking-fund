<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PH Sinking Fund - Firebase Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary-blue: #003366; --danger-red: #dc3545; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        #loginPage, #adminDashboard, #memberDashboard, #loadingScreen { display: none; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .history-item { border-left: 3px solid #198754; margin-bottom: 10px; padding-left: 15px; background: #fff; padding: 10px; border-radius: 5px; }
        .history-item.unpaid { border-left: 3px solid #dee2e6; color: #adb5bd; }
        .navbar { background-color: var(--primary-blue); }
        .unpaid-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 20px; background-color: #ffe5e5; color: var(--danger-red); border: 1px solid var(--danger-red); font-weight: bold; }
    </style>
</head>
<body>

<div id="loadingScreen" class="container text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">Connecting to Sinking Fund Cloud...</p>
</div>

<div id="loginPage" class="container py-5">
    <div class="row justify-content-center mt-5">
        <div class="col-md-5">
            <div class="card p-5 text-center">
                <h2 class="fw-bold text-primary mb-3">Sinking Fund Cloud</h2>
                <p class="text-muted">Secure Google Login for Members</p>
                <hr>
                <button class="btn btn-outline-dark w-100 py-3 fw-bold" onclick="signIn()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="20" class="me-2">
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>
</div>

<nav id="topNav" class="navbar navbar-dark mb-4 d-none">
    <div class="container d-flex justify-content-between">
        <span class="navbar-brand fw-bold">ðŸ‡µðŸ‡­ SF Cloud v8.0</span>
        <button class="btn btn-outline-light btn-sm" onclick="signOut()">LOGOUT</button>
    </div>
</nav>

<div id="adminDashboard" class="container">
    <div class="row mb-4 g-3 text-white">
        <div class="col-md-4"><div class="card p-3 bg-primary"><h6>Total Fund</h6><h2 id="admTotalColl">â‚±0</h2></div></div>
        <div class="col-md-4"><div class="card p-3 bg-danger"><h6>Active Loans</h6><h2 id="admTotalLoans">â‚±0</h2></div></div>
        <div class="col-md-4"><div class="card p-3 bg-success"><h6>Cash Hand</h6><h2 id="admCashHand">â‚±0</h2></div></div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Master Ledger</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="addMember()">+ Member</button>
                        <button class="btn btn-sm btn-success" onclick="addNewMonth()">+ Month</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle">
                        <thead id="tableHead" class="table-light"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card p-4 border-top border-danger border-4">
                <h5>Release Loan</h5>
                <select id="loanMemberSelect" class="form-select mb-2"></select>
                <input type="number" id="loanAmtInput" class="form-control mb-2" placeholder="Amount">
                <button class="btn btn-danger w-100" onclick="releaseLoan()">APPROVE</button>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card p-4 h-100">
                <h5>Active Loans</h5>
                <div id="loanLedgerList"></div>
            </div>
        </div>
    </div>
</div>

<div id="memberDashboard" class="container">
    <div class="row g-4">
        <div class="col-lg-4 text-center">
            <div class="card p-4 bg-primary text-white shadow">
                <img id="userPhoto" class="rounded-circle mx-auto mb-3" width="80">
                <h3 id="mDashName" class="fw-bold"></h3>
                <hr>
                <p class="mb-1">Total Saved</p>
                <h2 id="mDashContri">â‚±0</h2>
                <p class="mt-3 mb-1">Your Loan</p>
                <h3 id="mDashLoan" class="text-warning">â‚±0</h3>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card p-4 shadow-sm">
                <h5 class="fw-bold">Payment History</h5>
                <div id="paymentTimeline"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyC5nSdDA5IrA0Gpt_nUcpT2NI0kdGGU3wI",
        authDomain: "sinking-fund-51fcd.firebaseapp.com",
        projectId: "sinking-fund-51fcd",
        storageBucket: "sinking-fund-51fcd.firebasestorage.app",
        messagingSenderId: "943953104162",
        appId: "1:943953104162:web:872f8dbc6f3fac7c63a97b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // !!! CHANGE THIS TO YOUR EMAIL TO BE THE ADMIN !!!
    const ADMIN_EMAIL = "ev.lorens.ebrado@gmail.com"; 

    let appData = { settings: { contri: 100, interest: 5 }, members: [], cycles: ["Jan"], loans: [], profit: 0 };

    // --- AUTH LOGIC ---
    function signIn() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
    }

    function signOut() { auth.signOut(); location.reload(); }

    auth.onAuthStateChanged(user => {
        document.getElementById('loadingScreen').style.display = 'block';
        if (user) {
            syncData(user);
        } else {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
        }
    });

    // --- DATA SYNC ---
    function syncData(user) {
        db.collection("system").doc("main").onSnapshot(doc => {
            if (doc.exists) {
                appData = doc.data();
                routeUser(user);
            } else {
                // Initialize database if empty
                db.collection("system").doc("main").set(appData);
            }
            document.getElementById('loadingScreen').style.display = 'none';
        });
    }

    function routeUser(user) {
        document.getElementById('topNav').classList.remove('d-none');
        if (user.email === ADMIN_EMAIL) {
            document.getElementById('adminDashboard').style.display = 'block';
            renderAdmin();
        } else {
            document.getElementById('memberDashboard').style.display = 'block';
            renderMember(user);
        }
    }

    // --- ADMIN ACTIONS ---
    function renderAdmin() {
        const head = document.getElementById('tableHead');
        let h1 = '<tr><th>Member</th>';
        let h2 = '<tr><td></td>';
        appData.cycles.forEach(c => { h1 += `<th colspan="2" class="text-center">${c}</th>`; h2 += `<th class="text-center small">15th</th><th class="text-center small">30th</th>`; });
        head.innerHTML = h1 + '<th>Total</th></tr>' + h2 + '<td></td></tr>';

        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        let totalColl = 0;
        const lSelect = document.getElementById('loanMemberSelect');
        lSelect.innerHTML = '<option value="">Select Borrower</option>';

        appData.members.forEach((m, mIdx) => {
            let mSum = 0;
            let cells = `<td><b>${m.name}</b></td>`;
            m.payments.forEach((p, pIdx) => {
                if(p) mSum += appData.settings.contri;
                cells += `<td class="text-center"><input type="checkbox" ${p?'checked':''} onclick="togglePay(${mIdx},${pIdx})"></td>`;
            });
            totalColl += mSum;
            body.innerHTML += `<tr>${cells}<td class="fw-bold">â‚±${mSum}</td></tr>`;
            lSelect.innerHTML += `<option value="${m.name}">${m.name}</option>`;
        });

        const list = document.getElementById('loanLedgerList');
        list.innerHTML = '';
        let activeLoanVal = 0;
        appData.loans.forEach((l, idx) => {
            activeLoanVal += l.principal;
            list.innerHTML += `<div class="p-2 border-bottom d-flex justify-content-between">
                <span>${l.borrower} (â‚±${l.principal * (1+appData.settings.interest/100)})</span>
                <button class="btn btn-sm btn-success" onclick="collectLoan(${idx})">Paid</button>
            </div>`;
        });

        document.getElementById('admTotalColl').innerText = `â‚±${(totalColl + appData.profit).toLocaleString()}`;
        document.getElementById('admTotalLoans').innerText = `â‚±${activeLoanVal.toLocaleString()}`;
        document.getElementById('admCashHand').innerText = `â‚±${(totalColl + appData.profit - activeLoanVal).toLocaleString()}`;
    }

    function togglePay(mIdx, pIdx) {
        appData.members[mIdx].payments[pIdx] = !appData.members[mIdx].payments[pIdx];
        db.collection("system").doc("main").update(appData);
    }

    function releaseLoan() {
        const amt = parseFloat(document.getElementById('loanAmtInput').value);
        const name = document.getElementById('loanMemberSelect').value;
        if(!name || isNaN(amt)) return alert("Check inputs");
        appData.loans.push({ borrower: name, principal: amt });
        db.collection("system").doc("main").update(appData);
    }

    function collectLoan(idx) {
        appData.profit += (appData.loans[idx].principal * (appData.settings.interest/100));
        appData.loans.splice(idx, 1);
        db.collection("system").doc("main").update(appData);
    }

    function addMember() {
        const n = prompt("Member Google Name (Must match exactly):");
        if(n) { appData.members.push({name: n, payments: new Array(appData.cycles.length*2).fill(false)}); db.collection("system").doc("main").update(appData); }
    }

    function addNewMonth() {
        const m = prompt("Month (e.g. Feb):");
        if(m) { appData.cycles.push(m); appData.members.forEach(mem => mem.payments.push(false, false)); db.collection("system").doc("main").update(appData); }
    }

    // --- MEMBER ACTIONS ---
    function renderMember(user) {
        const member = appData.members.find(m => m.name === user.displayName);
        if(!member) {
            document.getElementById('mDashName').innerText = "Not Enrolled";
            return alert("You are not registered in the system yet. Contact Admin.");
        }
        
        document.getElementById('userPhoto').src = user.photoURL;
        document.getElementById('mDashName').innerText = user.displayName;
        
        let saved = 0;
        const timeline = document.getElementById('paymentTimeline');
        timeline.innerHTML = '';
        
        member.payments.forEach((p, idx) => {
            const cycle = appData.cycles[Math.floor(idx/2)];
            const day = idx % 2 === 0 ? "15th" : "30th";
            if(p) saved += appData.settings.contri;
            timeline.innerHTML += `<div class="history-item ${p?'':'unpaid'}">
                <b>${cycle} ${day}</b> - ${p?'Paid â‚±'+appData.settings.contri:'Pending'}
            </div>`;
        });
        
        document.getElementById('mDashContri').innerText = `â‚±${saved}`;
        const loan = appData.loans.find(l => l.borrower === user.displayName);
        document.getElementById('mDashLoan').innerText = loan ? `â‚±${loan.principal * (1+appData.settings.interest/100)}` : "â‚±0";
    }
</script>
</body>
</html>
